name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e
          
          echo "ğŸ“¦ Starting deployment..."
          
          # Navigate to app directory
          mkdir -p ~/dna-database
          cd ~/dna-database
          
          # Clone or pull latest code
          if [ -d ".git" ]; then
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main
          else
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/rodionmaulenov/dna-database.git .
          fi
          
          # Create production environment file
          echo "âš™ï¸  Configuring environment..."
          cat > .env.production << 'EOF'
           DEBUG=False
          SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
          ALLOWED_HOSTS=${{ secrets.EC2_HOST }},63.180.181.174,localhost,127.0.0.1
          
          DATABASE_NAME=dna_db
          DATABASE_USER=postgres
          DATABASE_PASSWORD=${{ secrets.DB_PASSWORD }}
          DATABASE_HOST=db
          DATABASE_PORT=5432
          
          CELERY_BROKER_URL=redis://redis:6379/0
          CELERY_RESULT_BACKEND=redis://redis:6379/0
          
          # AI API
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          
          # AWS S3
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_STORAGE_BUCKET_NAME=${{ secrets.AWS_STORAGE_BUCKET_NAME }}
          AWS_S3_REGION_NAME=${{ secrets.AWS_S3_REGION_NAME }}
          USE_S3=True
          EOF
          
          # Stop old containers
          echo "ğŸ›‘ Stopping old containers..."
          docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
          
          # Build and start new containers
          echo "ğŸ—ï¸  Building containers..."
          docker-compose -f docker-compose.prod.yml up -d --build
          
          # Wait for containers
          echo "â³ Waiting for services..."
          sleep 15
          
          # Show status
          echo "ğŸ“Š Container status:"
          docker-compose -f docker-compose.prod.yml ps
          
          echo "âœ… Deployment complete!"
          echo "ğŸŒ App: http://${{ secrets.EC2_HOST }}"