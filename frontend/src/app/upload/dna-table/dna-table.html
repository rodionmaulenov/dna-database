<div class="table-container">
  <div class="table-wrapper">

    @if (isLoading()) {
      <div class="loading-shade">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
    }

    <!-- ✅ Wrap table in virtual scroll viewport -->
    <div class="table-scroll-container mat-elevation-z8">

      <table mat-table
             [dataSource]="dataSource"
             [trackBy]="trackByPersonId"
             multiTemplateDataRows
             tabindex="0">

        <!-- All your existing column definitions -->
        <ng-container matColumnDef="number">
          <th mat-header-cell *matHeaderCellDef>No.</th>
          <td mat-cell *matCellDef="let element; let i = dataIndex">
            <div class="header-icon-alignment">
              <span>{{ pageIndex() * pageSize() + i + 1 }}</span>
              @if (isExpanded(element)) {
                <mat-icon class="row-icon-size" (click)="store.toggle(element);">
                  arrow_upward
                </mat-icon>
              } @else {
                <mat-icon class="row-icon-size" (click)="store.toggle(element);">
                  arrow_downward
                </mat-icon>
              }
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>Name</span>
              <mat-icon class="header-icon-size">edit</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" class="form-field-wrapper">
            @if (!isLoading()) {
              <!-- ✅ GET PERSONS ARRAY -->
              @let personsArray = $any(store.personsArrayForm())['persons'];

              <!-- ✅ FIND PERSON BY ID -->
              @for (personField of personsArray; track $any(personField)['id']().value()) {
                @if ($any(personField)['id']().value() === element.personId) {
                  <!-- ✅ NOW ACCESS NAME FIELD -->
                  @let nameField = $any(personField)['name'];

                  <mat-form-field appearance="fill"
                                  class="name-input"
                                  subscriptSizing="dynamic">
                    <input matInput [field]="nameField" [errorStateMatcher]="immediateErrorMatcher">
                    <mat-error>
                      @if (nameField().errors().length > 0) {
                        @for (error of nameField().errors(); track error.kind) {
                          {{ error.message }}
                        }
                      }
                    </mat-error>
                  </mat-form-field>
                }
              }
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>Role</span>
              <mat-icon class="header-icon-size">edit</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element">
            @if (!isLoading()) {
              <!-- ✅ GET PERSONS ARRAY -->
              @let personsArray = $any(store.personsArrayForm())['persons'];

              <!-- ✅ FIND PERSON BY ID -->
              @for (personField of personsArray; track $any(personField)['id']().value()) {
                @if ($any(personField)['id']().value() === element.personId) {
                  <!-- ✅ NOW ACCESS ROLE FIELD -->
                  @let roleField = $any(personField)['role'];

                  <mat-form-field appearance="fill"
                                  subscriptSizing="dynamic"
                                  class="role-select">
                    <mat-select [field]="roleField">
                      <mat-option value="father" class="select-option">
                        <mat-icon class="select-option-icon">man</mat-icon>
                        Father
                      </mat-option>
                      <mat-option value="mother" class="select-option">
                        <mat-icon class="select-option-icon">woman</mat-icon>
                        Mother
                      </mat-option>
                      <mat-option value="child" class="select-option">
                        <mat-icon class="select-option-icon">child_care</mat-icon>
                        Child
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                }
              }
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="loci_count">
          <th mat-header-cell *matHeaderCellDef>Locus Count</th>
          <td mat-cell *matCellDef="let element">{{ element.loci_count }}</td>
        </ng-container>

        <ng-container matColumnDef="related_person">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>Related Person</span>
              <mat-icon class="header-icon-size">filter_alt</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element">
            @if (element.relatedPersons && element.relatedPersons.length > 1) {
              <!-- Multiple persons -->
              <span (click)="store.filterByMultiplePersons(
                      getPersonIds(element.relatedPersons),
                      element.relatedPersons[0].role,
                      element.relatedPersons.length
                      )"
                    class="person-link">
                {{ element.relatedPersons.length }}
              </span>
            } @else if (element.relatedPersonName && element.relatedPersonId) {
              <!-- Single person -->
              <span (click)="store.filterByPerson(
                    element.relatedPersonId,
                    element.relatedPersonRole,
                    element.relatedPersonName
                    )"
                    class="person-link">
              {{ element.relatedPersonName }}
            </span>
            } @else {
              <span>-</span>
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="file">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>File(s)</span>
              <mat-icon class="header-icon-size">link</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">
            @if (element.files && element.files.length > 0) {
              <div class="file-chips">
                @for (file of getFiles(element); track file.id; let idx = $index) {
                  <div class="file-chip-wrapper">
                    <a [href]="file.file"
                       target="_blank"
                       class="file-chip"
                       [matTooltip]="'Uploaded: ' + (file.uploaded_at | date:'yyyy-MM-dd HH:mm')">
                      {{ idx + 1 }}
                    </a>
                    <button class="file-delete-btn"
                            (click)="confirmDeleteFile(element, file, idx)"
                            [disabled]="store.deletingFileId() === file.id">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                }
              </div>
            } @else {
              <span>-</span>
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>Actions</span>
              <mat-icon class="header-icon-size">settings</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element">
            <button matButton
                    [disabled]="!store.hasChanges(element)"
                    (click)="store.updateRow(element)">
              @if (store.isUpdating(element)) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                <div class="icon-alignment">
                  <mat-icon class="row-icon-size">save_as</mat-icon>
                  Update
                </div>
              }
            </button>

            <!-- ✅ Only show delete button for parents -->
            @if (element.role === 'father' || element.role === 'mother') {
              <button matButton
                      color="warn"
                      [disabled]="store.isUpdating(element)"
                      (click)="confirmDelete(element)">
                <div class="icon-alignment">
                  <mat-icon class="row-icon-size">delete</mat-icon>
                  Delete
                </div>
              </button>
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length">
            <div class="detail-wrapper" [class.expanded]="isExpanded(element)">
              <div class="detail-content">
                <div class="loci-section form-field-wrapper">
                  @if (!isLoading()) {

                    @let personsArray = $any(store.personsArrayForm())['persons'];

                    @for (personField of personsArray; track $any(personField)['id']().value()) {
                      @if ($any(personField)['id']().value() === element.personId) {
                        @let lociArray = $any(personField)['loci'];

                        @for (locusField of lociArray; track $index; let idx = $index) {
                          @let allelesField = $any(locusField)['alleles'];
                          @let locusNameField = $any(locusField)['locus_name'];

                          <div class="locus-item">
                            <mat-form-field class="locus-field"
                                            appearance="fill"
                                            subscriptSizing="dynamic">
                              <mat-label>{{ locusNameField().value() }}</mat-label>
                              <input matInput [field]="allelesField" [errorStateMatcher]="immediateErrorMatcher">
                              <mat-error>
                                @if (allelesField().errors().length > 0) {
                                  @for (error of allelesField().errors(); track error.kind) {
                                    {{ error.message }}
                                  }
                                }
                              </mat-error>
                            </mat-form-field>

                            <button mat-icon-button
                                    (click)="removeLocus(element, idx)"
                                    [matTooltip]="'Remove ' + locusNameField().value()">
                              <mat-icon class="remove-locus-icon">delete_sweep</mat-icon>
                            </button>
                          </div>
                        }
                      }
                    }
                  }

                  @if (isAddingLocus(element)) {
                    <div class="locus-item adding">
                      <mat-form-field class="locus-field" appearance="fill" subscriptSizing="dynamic">
                        <mat-label>Locus</mat-label>
                        <mat-select [(ngModel)]="selectedLocusName"
                                    (selectionChange)="onLocusSelected(element, $event.value)">
                          @for (locusName of getAvailableLociForRow(element); track locusName) {
                            <mat-option [value]="locusName">{{ locusName }}</mat-option>
                          }
                        </mat-select>
                      </mat-form-field>

                      <button mat-icon-button (click)="cancelAddLocus()" matTooltip="Cancel">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  }

                  @if (!isAddingLocus(element)) {
                    <button matMiniFab (click)="startAddingLocus(element)" class="add-locus-button">
                      <mat-icon>add</mat-icon>
                    </button>
                  }
                </div>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- ✅ Use sticky header -->
        <tr mat-header-row *matHeaderRowDef="columnsToDisplay; sticky: true"></tr>
        <tr mat-row
            *matRowDef="let element; columns: columnsToDisplay;"
            class="element-row"
            [class.expanded-row]="isExpanded(element)">
        </tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
      </table>

    </div>

    <!-- Paginator stays outside viewport -->
    <mat-paginator
      [length]="total()"
      [pageSize]="pageSize()"
      [pageIndex]="pageIndex()"
      (page)="loadPage($event.pageIndex)"
      showFirstLastButtons
      aria-label="Select page">
    </mat-paginator>
  </div>
</div>
