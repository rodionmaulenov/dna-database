<div class="table-container">
  <!-- TABLE -->
  <div class="table-wrapper">

    <div class="table-scroll-container mat-elevation-z8">

      @if (store.loading()) {
        <div class="loading-shade">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
      }

      <table mat-table [dataSource]="store.filteredTableData()" multiTemplateDataRows tabindex="0">

        <ng-container matColumnDef="number">
          <th mat-header-cell *matHeaderCellDef>No.</th>
          <td mat-cell *matCellDef="let element; let i = dataIndex">
            <div class="header-icon-alignment">
              <span>{{ (store.currentPage() - 1) * store.pageSize() + i + 1 }}</span>
              @if (isExpanded(element)) {
                <mat-icon class="row-icon-size">arrow_upward</mat-icon>
              } @else {
                <mat-icon class="row-icon-size">arrow_downward</mat-icon>
              }
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>Name</span>
              <mat-icon class="header-icon-size">edit</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" class="form-field-wrapper">
            <mat-form-field appearance="fill"
                            (click)="$event.stopPropagation()"
                            class="name-input"
                            subscriptSizing="dynamic">
              <input matInput
                     [formControl]="$any(formService.getRowForm(element).get('name'))">
              <!-- ⭐ Show validation error -->
              <mat-error>
                @if (formService.getRowForm(element).get('name')?.hasError('required')) {
                  Name is required
                }
                @if (formService.getRowForm(element).get('name')?.hasError('minlength')) {
                  Name must be at least 2 characters
                }
              </mat-error>
            </mat-form-field>
          </td>
        </ng-container>

        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef>Role</th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">{{ element.role }}</td>
        </ng-container>

        <ng-container matColumnDef="loci_count">
          <th mat-header-cell *matHeaderCellDef>Locus Count</th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">{{ element.loci_count }}</td>
        </ng-container>

        <ng-container matColumnDef="overall_confidence">
          <th mat-header-cell *matHeaderCellDef>Confidence</th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">{{ element.overall_confidence }}
          </td>
        </ng-container>

        <ng-container matColumnDef="uploaded_at">
          <th mat-header-cell *matHeaderCellDef>Uploaded</th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">
            {{ element.uploaded_at | date:'yyyy-MM-dd' }}
          </td>
        </ng-container>

        <!-- ⭐ Clickable Related Person Column -->
        <ng-container matColumnDef="related_person">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>{{ store.getRelatedPersonLabel() }}</span>
              <mat-icon class="header-icon-size">filter_alt</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">
            @if (element.relatedPersonName && element.relatedPersonId) {
              <button mat-button
                      (click)="filterByPerson(element.relatedPersonId, element.relatedPersonRole)">
                {{ element.relatedPersonName }}
              </button>
            } @else {
              <span class="no-related">-</span>
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="file">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>File</span>
              <mat-icon class="header-icon-size">link</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">
            <a [href]="store.getFileUrl(element.file)" target="_blank" class="file-link">
              {{ element.file }}
            </a>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>Actions</span>
              <mat-icon class="header-icon-size">settings</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">
            <button matButton
                    [disabled]="!hasChanges(element) || isUpdating(element)"
                    (click)="updateRow(element)">
              @if (isUpdating(element)) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                <div class="icon-alignment">
                  <mat-icon class="row-icon-size">save_as</mat-icon>
                  Update
                </div>
              }
            </button>

            <button matButton
                    color="warn"
                    [disabled]="isUpdating(element)"
                    (click)="confirmDelete(element)">
              <div class="icon-alignment">
                <mat-icon class="row-icon-size">delete</mat-icon>
                Delete
              </div>
            </button>
          </td>
        </ng-container>


        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length">
            <div class="detail-wrapper" [class.expanded]="isExpanded(element)">
              <div class="detail-content">
                <div class="loci-section form-field-wrapper">
                  @for (locus of element.loci; track locus.id; let idx = $index) {
                    <mat-form-field class="locus-field"
                                    appearance="fill"
                                    (click)="$event.stopPropagation()"
                                    subscriptSizing="dynamic">
                      <mat-label>{{ locus.locus_name }}</mat-label>
                      <input matInput
                             [formControl]="$any(formService.getLocusFormGroup(element, idx).get('alleles'))">
                      <!-- ⭐ Show validation error -->
                      <mat-error>
                        @if (formService.getLocusFormGroup(element, idx).get('alleles')?.hasError('required')) {
                          Alleles are required
                        }
                      </mat-error>

                    </mat-form-field>
                  }
                </div>
              </div>
            </div>
          </td>
        </ng-container>


        <tr mat-header-row *matHeaderRowDef="columnsToDisplay; sticky: true"></tr>
        <tr mat-row
            *matRowDef="let element; columns: columnsToDisplay;"
            class="element-row"
            [class.expanded-row]="isExpanded(element)"
            (click)="toggle(element)">
        </tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
      </table>
    </div>
    <!-- ⭐ MATERIAL PAGINATOR -->
    <mat-paginator
      [length]="store.totalRecords()"
      [pageSize]="store.pageSize()"
      [pageIndex]="store.currentPage() - 1"
      [pageSizeOptions]="[20, 50, 100]"
      (page)="onPageChange($event)"
      showFirstLastButtons
      aria-label="Select page">
    </mat-paginator>
  </div>
</div>

