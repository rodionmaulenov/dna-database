<div class="table-container">
  <div class="table-wrapper">

    @if (store.loading()) {
      <div class="loading-shade">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
    }

    <!-- ✅ Wrap table in virtual scroll viewport -->
    <div class="table-scroll-container mat-elevation-z8">

      <table mat-table
             [dataSource]="dataSource"
             [trackBy]="trackByPersonId"
             multiTemplateDataRows
             tabindex="0">

        <!-- All your existing column definitions -->
        <ng-container matColumnDef="number">
          <th mat-header-cell *matHeaderCellDef>No.</th>
          <td mat-cell *matCellDef="let element; let i = dataIndex">
            <div class="header-icon-alignment">
              <span>{{ (store.currentPage() - 1) * store.pageSize() + i + 1 }}</span>
              @if (isExpanded(element)) {
                <mat-icon class="row-icon-size">arrow_upward</mat-icon>
              } @else {
                <mat-icon class="row-icon-size">arrow_downward</mat-icon>
              }
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>Name</span>
              <mat-icon class="header-icon-size">edit</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" class="form-field-wrapper">
            <mat-form-field appearance="fill"
                            (click)="$event.stopPropagation()"
                            class="name-input"
                            subscriptSizing="dynamic">
              <input matInput
                     [formControl]="$any(formService.getRowForm(element).get('name'))">
              <mat-error>
                @if (formService.getRowForm(element).get('name')?.hasError('required')) {
                  Name is required
                }
                @if (formService.getRowForm(element).get('name')?.hasError('minlength')) {
                  Name must be at least 2 characters
                }
              </mat-error>
            </mat-form-field>
          </td>
        </ng-container>

        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>Role</span>
              <mat-icon class="header-icon-size">edit</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">
            <mat-form-field appearance="fill"
                            subscriptSizing="dynamic"
                            (click)="$event.stopPropagation()"
                            class="role-select">
              <mat-select [formControl]="$any(formService.getRowForm(element).get('role'))">
                <mat-option value="father" class="select-option">
                  <mat-icon class="select-option-icon">man</mat-icon>
                  Father
                </mat-option>
                <mat-option value="mother" class="select-option">
                  <mat-icon class="select-option-icon">woman</mat-icon>
                  Mother
                </mat-option>
                <mat-option value="child" class="select-option">
                  <mat-icon class="select-option-icon">child_care</mat-icon>
                  Child
                </mat-option>
              </mat-select>
            </mat-form-field>
          </td>
        </ng-container>

        <ng-container matColumnDef="loci_count">
          <th mat-header-cell *matHeaderCellDef>Locus Count</th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">{{ element.loci_count }}</td>
        </ng-container>

        <ng-container matColumnDef="related_person">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>{{ store.relatedPersonLabel() }}</span>
              <mat-icon class="header-icon-size">filter_alt</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">
            @if (element.relatedPersons && element.relatedPersons.length > 1) {
              <span (click)="filterByMultiplePersons(element.relatedPersons)" class="person-link">
                {{ element.relatedPersons.length }}
              </span>
            } @else if (element.relatedPersonName && element.relatedPersonId) {
              <span (click)="filterByPerson(element.relatedPersonId, element.relatedPersonRole)"
                    class="person-link">
                {{ element.relatedPersonName }}
              </span>
            } @else {
              <span>-</span>
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="file">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>File(s)</span>
              <mat-icon class="header-icon-size">link</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">
            @if (element.files && element.files.length > 1) {
              <!-- Multiple files - show as numbered chips -->
              <div class="file-chips">
                @for (file of getFiles(element); track file.id; let idx = $index) {
                  <a [href]="file.file"
                     target="_blank"
                     class="file-chip"
                     [matTooltip]="'Uploaded: ' + (file.uploaded_at | date:'yyyy-MM-dd HH:mm')">
                    {{ idx + 1 }}
                  </a>
                }
              </div>
            } @else if (element.files && element.files.length === 1) {
              <!-- Single file - show text link -->
              <a [href]="element.files[0].file"
                 target="_blank"
                 class="file-link"
                 [matTooltip]="'Uploaded: ' + (element.files[0].uploaded_at | date:'yyyy-MM-dd HH:mm')">
                file
              </a>
            } @else {
              <!-- No files -->
              <span>-</span>
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>Actions</span>
              <mat-icon class="header-icon-size">settings</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">
            <button matButton
                    [disabled]="!hasChanges(element) || isUpdating(element)"
                    (click)="updateRow(element)">
              @if (isUpdating(element)) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                <div class="icon-alignment">
                  <mat-icon class="row-icon-size">save_as</mat-icon>
                  Update
                </div>
              }
            </button>

            <!-- ✅ Only show delete button for parents -->
            @if (element.role === 'father' || element.role === 'mother') {
              <button matButton
                      color="warn"
                      [disabled]="isUpdating(element)"
                      (click)="confirmDelete(element)">
                <div class="icon-alignment">
                  <mat-icon class="row-icon-size">delete</mat-icon>
                  Delete
                </div>
              </button>
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length">
            <div class="detail-wrapper" [class.expanded]="isExpanded(element)">
              <div class="detail-content">
                <div class="loci-section form-field-wrapper">

                  @for (locus of element.loci; track $index; let idx = $index) {
                    <div class="locus-item">
                      <mat-form-field class="locus-field"
                                      appearance="fill"
                                      (click)="$event.stopPropagation()"
                                      subscriptSizing="dynamic">
                        <mat-label>{{ locus.locus_name }}</mat-label>
                        <input matInput
                               [formControl]="$any(formService.getLocusFormGroup(element, idx).get('alleles'))">
                        <mat-error>
                          @if (formService.getLocusFormGroup(element, idx).get('alleles')?.hasError('required')) {
                            Alleles are required
                          }
                        </mat-error>
                      </mat-form-field>

                      <button mat-icon-button
                              (click)="removeLocus(element, idx); $event.stopPropagation()"
                              [matTooltip]="'Remove ' + locus.locus_name">
                        <mat-icon class="remove-locus-icon">delete_sweep</mat-icon>
                      </button>
                    </div>
                  }

                  @if (isAddingLocus(element)) {
                    <div class="locus-item adding">
                      <mat-form-field class="locus-field"
                                      appearance="fill"
                                      (click)="$event.stopPropagation()"
                                      subscriptSizing="dynamic">
                        <mat-label>Locus</mat-label>
                        <mat-select [(ngModel)]="selectedLocusName"
                                    (selectionChange)="onLocusSelected(element, $event.value)">
                          @for (locusName of getAvailableLoci(element); track locusName) {
                            <mat-option [value]="locusName">{{ locusName }}</mat-option>
                          }
                        </mat-select>
                      </mat-form-field>

                      <button mat-icon-button
                              (click)="cancelAddLocus(); $event.stopPropagation()"
                              matTooltip="Cancel">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  }

                  @if (!isAddingLocus(element)) {
                    <button matMiniFab
                            (click)="startAddingLocus(element); $event.stopPropagation()"
                            class="add-locus-button">
                      <mat-icon>add</mat-icon>
                    </button>
                  }
                </div>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- ✅ Use sticky header -->
        <tr mat-header-row *matHeaderRowDef="columnsToDisplay; sticky: true"></tr>
        <tr mat-row
            *matRowDef="let element; columns: columnsToDisplay;"
            class="element-row"
            [class.expanded-row]="isExpanded(element)"
            (click)="toggle(element)">
        </tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
      </table>

    </div>

    <!-- Paginator stays outside viewport -->
    <mat-paginator
      [length]="store.totalRecords()"
      [pageSize]="store.pageSize()"
      [pageIndex]="store.currentPage() - 1"
      [pageSizeOptions]="[20, 50]"
      (page)="onPageChange($event)"
      showFirstLastButtons
      aria-label="Select page">
    </mat-paginator>
  </div>
</div>
