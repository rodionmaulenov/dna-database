<div class="upload-sheet-container">

  <!-- Controls -->
  <div class="upload-controls">
    <div class="upload-actions">
      <input #fileInput type="file" (change)="onFileSelect($event)" accept=".pdf"
             [multiple]="store.selectedRole() === 'save'" hidden>

      <button matMiniFab (click)="fileInput.click()" [disabled]="store.isUploading()">
        <mat-icon>attach_file</mat-icon>
      </button>

      <button matMiniFab (click)="upload()" [disabled]="!store.hasFilesToUpload() || store.isUploading()">
        <mat-icon>{{ store.selectedRole() === 'save' ? 'upload' : 'search' }}</mat-icon>
      </button>

      <button matMiniFab (click)="clearAll()" [disabled]="store.files().length === 0 || store.isUploading()">
        <mat-icon>clear_all</mat-icon>
      </button>
    </div>

    <mat-form-field appearance="outline" subscriptSizing="dynamic">
      <mat-label>Mode</mat-label>
      <mat-select [value]="store.selectedRole()" (selectionChange)="store.setRole($event.value)">
        <mat-option value="save">
          <mat-icon>save</mat-icon>
          Save
        </mat-option>
        <mat-option value="parent">
          <mat-icon>child_care</mat-icon>
          Find child
        </mat-option>
        <mat-option value="child">
          <mat-icon>people</mat-icon>
          Find parent
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <!-- Files -->
  @if (store.files().length > 0) {
    <div class="files-list">
      @for (file of store.files(); track $index) {
        <div class="file-row">
          <div class="file-info">
            <mat-icon class="pdf-icon">picture_as_pdf</mat-icon>
            <span class="file-name">{{ file.file.name }}</span>

            <div class="file-action">
              @switch (file.status) {
                @case ('idle') {
                  <button mat-icon-button (click)="removeFile($index)">
                    <span class="material-symbols-outlined">close</span>
                  </button>
                }
                @case ('uploading') {
                  <mat-spinner diameter="24"></mat-spinner>
                }
                @case ('success') {
                  <span class="success-icon material-symbols-outlined">task_alt</span>
                }
                @case ('error') {
                  <span class="error-icon material-symbols-outlined">error</span>
                }
              }
            </div>
          </div>

          @if (file.status === 'error') {
            @let errorMsg = file.response?.errors?.[0];
            @if (errorMsg) {
              <div class="error-message">
                {{ errorMsg }}
                @for (link of file.response?.links; track link.person_id) {
                  <a (click)="viewPerson(link.person_id, link.role, link.name)">[{{ link.role }}]</a>
                }
              </div>
            }
          }

          @if (file.status === 'success' && file.response?.top_matches?.length && store.selectedRole() !== 'save') {
            <mat-nav-list class="matches">
              @for (match of file.response!.top_matches!.slice(0, 3); track match.person_id) {
                <mat-list-item (click)="viewMatch(match)">
                  <mat-chip matListItemIcon class="match-chip">{{ match.match_percentage }}%</mat-chip>
                  <span matListItemTitle>{{ match.name }}</span>
                  <span matListItemLine>{{ match.matching_loci }}/{{ match.total_loci }} loci</span>
                </mat-list-item>
              }
            </mat-nav-list>
          }
        </div>
      }
    </div>
  } @else {
    <div class="empty-state">
      <mat-icon>cloud_upload</mat-icon>
      <p>No files selected</p>
    </div>
  }

</div>
