<div class="table-card">

  <!-- Header -->
  <div class="table-card-header">
  <span class="table-card-title">
    @if (selection.hasValue()) {
      {{ selection.selected.length }} selected
    } @else {
      DNA Persons
    }
  </span>

    <div class="table-card-actions">
      <!-- Save -->
      <button mat-icon-button
              [disabled]="!expandedRowId() || !store.hasChanges(getExpandedElement()!)"
              (click)="store.updateRow(getExpandedElement()!)"
              matTooltip="Save changes">
        <mat-icon>save</mat-icon>
      </button>

      <!-- Delete -->
      <button mat-icon-button
              [disabled]="!selection.hasValue() || store.isDeleting()"
              (click)="deleteSelected()"
              matTooltip="Delete selected">
        <mat-icon>delete</mat-icon>
      </button>
    </div>
  </div>

  <!-- Body -->
  <div class="table-card-body">

    @if (isLoading()) {
      <div class="loading-shade">
        <mat-spinner></mat-spinner>
      </div>
    }

    <div class="table-scroll-container">
      <table mat-table
             [dataSource]="dataSource()"
             [trackBy]="trackByPersonId"
             multiTemplateDataRows
             tabindex="0">

        <ng-container matColumnDef="number">
          <th mat-header-cell *matHeaderCellDef>No.</th>
          <td mat-cell *matCellDef="let i = dataIndex">
            {{ pageIndex() * pageSize() + i + 1 }}
          </td>
        </ng-container>

        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox (change)="$event ? store.toggleAllRows() : null"
                          [checked]="selection.hasValue() && store.isAllSelected()"
                          [indeterminate]="selection.hasValue() && !store.isAllSelected()"
                          [aria-label]="store.checkboxLabel()">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row">
            <mat-checkbox (click)="$event.stopPropagation()"
                          (change)="$event ? selection.toggle(row) : null"
                          [checked]="selection.isSelected(row)"
                          [aria-label]="store.checkboxLabel(row)">
            </mat-checkbox>
          </td>
        </ng-container>

        <ng-container matColumnDef="expand">
          <th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button
                    aria-label="expand row"
                    (click)="toggleExpanded(element); $event.stopPropagation()"
                    class="toggle-button"
                    [class.toggle-button-expanded]="expandedRowId() === element.personId">
              <mat-icon>keyboard_arrow_down</mat-icon>
            </button>
          </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Full name</th>
          <td mat-cell *matCellDef="let row">{{ row.name }}</td>
        </ng-container>

        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef>Role</th>
          <td mat-cell *matCellDef="let row">{{ row.role }}</td>
        </ng-container>

        <ng-container matColumnDef="loci_count">
          <th mat-header-cell *matHeaderCellDef>Locus Count</th>
          <td mat-cell *matCellDef="let row">{{ row.loci_count }}</td>
        </ng-container>

        <ng-container matColumnDef="related_person">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>Related Person</span>
              <mat-icon class="header-icon-size">filter_alt</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let row">
            @if (row.relatedPersons && row.relatedPersons.length > 1) {
              <span (click)="store.filterByMultiplePersons(
                        getPersonIds(row.relatedPersons),
                        row.relatedPersons[0].role,
                        row.relatedPersons.length
                        )"
                    class="person-link">
                {{ row.relatedPersons.length }}
              </span>
            } @else if (row.relatedPersonName && row.relatedPersonId) {
              <span (click)="store.filterByPerson(
                      row.relatedPersonId,
                      row.relatedPersonRole,
                      row.relatedPersonName
                      )"
                    class="person-link">
                {{ row.relatedPersonName }}
              </span>
            } @else {
              <span>-</span>
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="file">
          <th mat-header-cell *matHeaderCellDef>
            <div class="header-icon-alignment">
              <span>File(s)</span>
              <mat-icon class="header-icon-size">link</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let row" (click)="$event.stopPropagation()">
            @if (row.files && row.files.length > 0) {
              <div class="file-chips">
                @for (file of getFiles(row); track file.id; let idx = $index) {
                  <div class="file-chip-wrapper">
                    <a [href]="file.file"
                       target="_blank"
                       class="file-chip"
                       [matTooltip]="'Uploaded: ' + (file.uploaded_at | date:'yyyy-MM-dd HH:mm')">
                      {{ idx + 1 }}
                    </a>
                    <button class="file-delete-btn"
                            (click)="confirmDeleteFile(row, file, idx)"
                            [disabled]="store.deletingFileId() === file.id">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                }
              </div>
            } @else {
              <span>-</span>
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let row" [attr.colspan]="columnsToDisplay.length">
            <div class="element-detail-wrapper"
                 [class.element-detail-wrapper-expanded]="expandedRowId() === row.personId">
              @if (expandedRowId() === row.personId) {
                <app-expandable-row [element]="row"></app-expandable-row>
              }
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnsToDisplay; sticky: true"></tr>
        <tr mat-row
            *matRowDef="let row; columns: columnsToDisplay;"
            class="element-row"
            [class.expanded-row]="expandedRowId() === row.personId"
            (click)="selection.toggle(row)">
        </tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
      </table>
    </div>

    <mat-paginator
      [length]="total()"
      [pageSize]="pageSize()"
      [pageIndex]="pageIndex()"
      (page)="loadPage($event.pageIndex)"
      aria-label="Select page">
    </mat-paginator>

  </div>
</div>


