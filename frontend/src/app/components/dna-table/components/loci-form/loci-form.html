<div class="loci-section">

  @for (locus of store.getPersonLociFields(element().personId); track locus.index) {
    @let allelesField = $any(locus.field)['alleles'];
    @let locusNameField = $any(locus.field)['locus_name'];

    <div class="locus-item">
      <mat-form-field class="locus-field" appearance="outline" subscriptSizing="dynamic">
        <mat-label>{{ locusNameField().value() }}</mat-label>
        <input matInput [field]="allelesField" [errorStateMatcher]="immediateErrorMatcher">
        <mat-error>
          @if (allelesField().errors().length > 0) {
            @for (error of allelesField().errors(); track error.kind) {
              {{ error.message }}
            }
          }
        </mat-error>
      </mat-form-field>

      <button mat-icon-button
              (click)="removeLocus(locus.index)"
              [matTooltip]="'Remove ' + locusNameField().value()">
        <mat-icon class="remove-locus-icon">delete_sweep</mat-icon>
      </button>
    </div>
  }

  @if (isAddingLocus()) {
    <div class="locus-item">
      <mat-form-field class="locus-field" appearance="outline" subscriptSizing="dynamic">
        <mat-label>Locus</mat-label>
        <mat-select [(ngModel)]="selectLocusName"
                    (selectionChange)="onLocusSelected($event.value)">
          @for (locusName of getAvailableLociForRow(); track locusName) {
            <mat-option [value]="locusName">{{ locusName }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <button mat-icon-button (click)="cancelAddLocus()" matTooltip="Cancel">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  }

  @if (!isAddingLocus()) {
    <button mat-icon-button (click)="startAddingLocus()" matTooltip="Add locus">
      <mat-icon>add</mat-icon>
    </button>
  }
</div>
